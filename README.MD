ä¼ é€é—¨æ•™ç¨‹ï¼šhttps://miyogurt.github.io/nodelover-books/#/koa-todo-api/æ­å»ºé¡¹ç›®å¼€å‘ç¯å¢ƒ

æºç åœ°å€ï¼šhttps://github.com/MiYogurt/todo-api

---

**1 æ–°å»ºé¡¹ç›®**ï¼š`$ mkdir todo && cd todo && npm init -y && git init`

**2 å®‰è£… Typescript ç¯å¢ƒ**ï¼š`$ npm i -g typescript && tsc --init`

**3 å®‰è£…ä¾èµ–é¡¹**ï¼š`$ npm i koa -S && npm i @types/koa @types/node -D`

**4 é…ç½®tsconfig.json**ï¼šé…ç½®è¾“å‡ºæ–‡ä»¶å¤¹ï¼Œä¸”ä½¿å…¶æ”¯æŒ async/await ç‰¹æ€§ã€‚

```JavaScript
{
    "compilerOptions": {
        "module": "commonjs",
        "target": "es6",
        "noImplicitAny": false,
        "sourceMap": false,
        "outDir": "dist",
        "lib": [
            "es6",
            "es7"
        ]
    }
}
```

**5 åˆ›å»º src/index.ts ï¼š**

```Typescript
import * as Koa from 'koa';

const app = new Koa();

app.use(async ctx => {
    ctx.body = "Todo App";
});

app.listen(3000, () => {
    console.log("Server Stared on http://localhost:3000")
})
```

ç”±äºä½¿ç”¨äº† **Typescript** ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ **Node.js** ä¸­ä½¿ç”¨ `es6 modules` è§„èŒƒäº†ã€‚

âœ… æˆ‘ä»¬å…ˆåœ¨å‘½ä»¤è¡Œé‡Œé¢è¾“å…¥ï¼š `$ tsc` 

ç„¶åä¼šå¯¹æ‰€æœ‰.tsæ–‡ä»¶è¿›è¡Œç¼–è¯‘ã€‚å½“ç¼–è¯‘å®Œæˆä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥å¯ä»¥çœ‹åˆ°ä¸€ä¸ª dist æ–‡ä»¶å¤¹ã€‚


**6 package.json å¢åŠ  start è„šæœ¬**

```bash
"start": "node dist/index.js"
```

å†åœ¨å‘½ä»¤è¡Œé‡Œé¢è¿è¡Œï¼š`npm start`

**7 éƒ¨ç½² node æœåŠ¡å™¨çš„ç¥å™¨ï¼š pm2**ï¼š`$ npm i -g pm2`

éš¾é“æ¯æ¬¡å†™å®Œä»£ç æˆ‘éƒ½éœ€è¦é‡å¯æœåŠ¡å™¨ï¼Ÿ

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ pm2 è¿™ä¸ªå·¥å…·ï¼Œè¿™æ˜¯ä¸€ä¸ªéƒ¨ç½² node æœåŠ¡å™¨çš„ç¥å™¨ï¼Œèƒ½å¤Ÿå®ç°è‡ªåŠ¨é‡å¯ã€‚

âœ… åœ¨ package.json é‡Œé¢æ·»åŠ ä¸€äº›è„šæœ¬ï¼š

```JavaScript
"scripts": {
    "tsc": "tsc --watch",
    "start": "pm2 start dist/index.js --watch dist"
},
```

âš ï¸ æ­¤æ—¶æˆ‘ä»¬éœ€è¦å¯åŠ¨ä¿©ä¸ªæ§åˆ¶å°ï¼šå…ˆè¿è¡Œ tsc å‘½ä»¤ï¼Œå†è¿è¡Œ startã€‚

```JavaScript
$ npm run tsc

/* æ–°å»ºå¦ä¸€ä¸ªçª—å£ */

$ npm run start
```

## ğŸ”— å®‰è£… koa æ’ä»¶

ğŸš€ æ‰€æœ‰ koa æ’ä»¶éƒ½å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼šhttps://github.com/koajs/koa/wiki

```JavaScript
// å®‰è£…ã€body è§£ææ’ä»¶ã€ä¸ã€å…¼å®¹æ€§è½¬æ¢æ’ä»¶ã€
$ npm install koa-better-body koa-convert -S

// å®‰è£…ã€è·¯ç”±æ’ä»¶ã€
$ npm install koa-better-router -S
```

ğŸ“ ä¿®æ”¹æˆ‘ä»¬çš„ `index.ts`

```JavaScript
import * as Koa from 'koa';
import * as bodyParser from 'koa-better-body';
import * as Router from 'koa-better-router';
import * as Convert from 'koa-convert';

const router = Router().loadMethods();

const app = new Koa();

router.get('/hello', async (ctx, next) => {
  ctx.body = `Hello world! Prefix: ${ctx.route.prefix}`
  await next()
});

router.get('/foobar', async (ctx, next) => {
  ctx.body = `Foo Bar Baz! ${ctx.route.prefix}`
  await next()
})

const api = Router({ prefix: '/api' })
api.extend(router)

app.use(Convert(bodyParser()));
app.use(router.middleware());
app.use(api.middleware());

app.listen(3000, () => {
    console.log("Server Stared on http://localhost:3000")
});
```

## ğŸ“Š æ•°æ®åº“ sqlite3

ä¸ºäº†ç®€å•çš„æ¨¡æ‹Ÿæ•°æ®åº“è¡Œä¸ºï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å°çš„æ•°æ®åº“ **sqlite3**ã€‚

> ä¸‹è½½ sqlite3 ç›´æ¥åˆ°å®˜ç½‘çš„ download é¡µé¢ï¼šhttps://www.sqlite.org/download.html
> 
> æ³¨æ„ï¼Œå‡å¦‚æ‚¨æ˜¯ win è¯·ä¸‹è½½ï¼š **sqlite-tools-win32-x86-3280000.zip**

æ¯ä¸€ä¸ªå¼€å‘è€…éƒ½ä¸åº”è¯¥ç›´æ¥æ“ ä½œSQLï¼Œè€Œæ˜¯æŠŠæ›´å¤šçš„æ—¶é—´ä¸“æ³¨åœ¨ä¸šåŠ¡ä¸Šé¢å»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ ORMï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹© `sequelize`ã€‚

```
// æ¨èç”¨ cnpm å®‰è£… sqlite3
$ cnpm i sequelize @types/sequelize sqlite3 -S
```

## ğŸš€ å®‰è£… sqlite studio

ä¸‹è½½åœ°å€ï¼šhttps://sqlitestudio.pl/index.rvt

åœ¨æ ¹ç›®å½•ä¸‹é¢åˆ›å»ºä¸€ä¸ª `storage/db.sqlite3` çš„ç©ºæ–‡ä»¶ç”¨æ¥å½“åšæ•°æ®åº“ã€‚

ç„¶åç”¨ sqlite studio æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ã€‚

![](https://s2.ax1x.com/2019/06/02/V8mZUP.png)

- ğŸ“ åˆ›å»º user è¡¨

```sql
CREATE TABLE user (
    id       INTEGER       PRIMARY KEY AUTOINCREMENT,
    usernmae VARCHAR (255) NOT NULL
                           UNIQUE,
    email    VARCHAR (40)  UNIQUE
                           NOT NULL,
    password VARCHAR (255) NOT NULL
);
```

- ğŸ“ åˆ›å»º todo_folder è¡¨

```sql
CREATE TABLE todo_folder (
    id      INTEGER PRIMARY KEY AUTOINCREMENT
                    UNIQUE,
    user_id INTEGER REFERENCES user (id) 
                    NOT NULL,
    title   TEXT    NOT NULL
);
```

- ğŸ“ åˆ›å»º todo è¡¨

```sql
CREATE TABLE todo (
    id             INTEGER PRIMARY KEY AUTOINCREMENT
                           UNIQUE,
    todo_folder_id         REFERENCES todo_folder (id) 
                           NOT NULL,
    text           TEXT    NOT NULL,
    created_at     TIME,
    updated_at     TIME
);
```


## ğŸš€ å®‰è£… `password-hash`
ç”¨æ¥å¤„ç†ç”¨æˆ·å¯†ç ï¼Œä¸å­˜å‚¨ç”¨æˆ·çš„æ˜æ–‡å¯†ç ï¼Œè€Œæ˜¯å­˜å‚¨åŠ å¯†åçš„ã€‚


âœ… æ–°å»º `src/db.ts`ï¼Œç”¨äºæµ‹è¯•è¿æ¥æ•°æ®åº“ã€‚

`$ npm i password-hash -S`

```Typescript
import { Sequelize, DataTypes, Model } from 'sequelize'
import * as ph from 'password-hash'
import { resolve } from 'path'

const sequelize = new Sequelize('db', null, null, {
    dialect: 'sqlite',
    storage: resolve(__dirname, '../storage/db.sqlite3')
})

class User extends Model {
    public id!: number;
    public usernmae!: string;
    public email!: string;
    public password!: string;
}

User.init({
    id: {
        type: DataTypes.INTEGER,
        primaryKey: true,
        autoIncrement: true
    },
    username: {
        type: DataTypes.STRING,
    },
    email: {
        type: DataTypes.STRING
    },
    password: {
        type: DataTypes.STRING
    }
}, {
    sequelize,
    timestamps: false,
    tableName: 'user',
})

User.create({
    username: 'yugo',
    email: 'belovedyogurt@gmail.com',
    password: ph.generate('123456')
}).then(console.log)
```

âœ… å…ˆæ‰§è¡Œ `tsc`ï¼Œç¼–è¯‘æˆåŠŸä¹‹åå†æ‰§è¡Œ `node ./dist/db.js` ã€‚

æ­£å¸¸çš„è¯æ•°æ®è¡¨ä¼šå¤šä¸€æ¡æ•°æ®ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š

![](https://s2.ax1x.com/2019/06/02/V8dY34.png)

âš ï¸ è§£å†³å…³äº: TypeError: Class constructor Model cannot be invoked without 'new'

> ğŸ“ tsconfig.json å°† "target" æ”¹ä¸º "es6" å³å¯

